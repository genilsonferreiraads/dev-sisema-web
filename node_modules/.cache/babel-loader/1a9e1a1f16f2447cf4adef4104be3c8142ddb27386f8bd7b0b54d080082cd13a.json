{"ast":null,"code":"import { supabase } from './supabase';\nexport const authService = {\n  async signIn(username, password) {\n    if (!username || !password) return null;\n    try {\n      const {\n        data,\n        error\n      } = await supabase.rpc('check_password', {\n        p_username: username,\n        p_password: password\n      });\n      if (error) throw error;\n      if (data && Array.isArray(data) && data.length > 0) {\n        const user = data[0];\n        const userData = {\n          id: user.id,\n          username: user.username,\n          full_name: user.full_name,\n          role: user.role,\n          display_name: user.display_name\n        };\n        localStorage.setItem('user', JSON.stringify(userData));\n        return userData;\n      }\n      return null;\n    } catch (error) {\n      throw error;\n    }\n  },\n  async getCurrentUser() {\n    try {\n      const storedUser = localStorage.getItem('user');\n      if (!storedUser) return null;\n      const currentUser = JSON.parse(storedUser);\n      const {\n        data,\n        error\n      } = await supabase.rpc('get_user_data', {\n        p_username: currentUser.username\n      });\n      if (error || !data) {\n        console.error('Erro ao buscar usuário:', error);\n        localStorage.removeItem('user');\n        return null;\n      }\n\n      // Garante que retornamos um objeto único, não um array\n      const updatedUser = Array.isArray(data) ? data[0] : data;\n\n      // Atualiza o localStorage com os dados mais recentes\n      localStorage.setItem('user', JSON.stringify(updatedUser));\n      return updatedUser;\n    } catch (error) {\n      console.error('Erro ao obter usuário atual:', error);\n      localStorage.removeItem('user');\n      return null;\n    }\n  },\n  async signOut() {\n    localStorage.removeItem('user');\n  },\n  async changePassword(username, adminPassword, newPassword) {\n    try {\n      if (!username || !adminPassword || !newPassword) {\n        console.error('Dados inválidos:', {\n          hasUsername: !!username,\n          hasAdminPassword: !!adminPassword,\n          hasNewPassword: !!newPassword\n        });\n        throw new Error('Todos os campos são obrigatórios');\n      }\n\n      // Pega o usuário atual do localStorage\n      const currentUser = localStorage.getItem('user');\n      if (!currentUser) {\n        throw new Error('Usuário não autenticado');\n      }\n      const user = JSON.parse(currentUser);\n      console.log('Usuário atual:', {\n        username: user.username,\n        role: user.role\n      });\n      console.log('Tentando alterar senha para usuário:', username);\n      console.log('Chamando change_password com:', {\n        username,\n        adminPassword,\n        newPassword\n      });\n      const {\n        data,\n        error\n      } = await supabase.rpc('change_password', {\n        p_username: username,\n        p_admin_password: adminPassword,\n        p_new_password: newPassword\n      });\n      console.log('Resposta do change_password:', {\n        data,\n        error\n      });\n      if (error) {\n        console.error('Erro ao alterar senha:', error);\n        throw error;\n      }\n      return data || false;\n    } catch (error) {\n      console.error('Erro ao alterar senha:', error);\n      throw error;\n    }\n  },\n  async updateUsername(currentUsername, newUsername, adminPassword) {\n    const {\n      data,\n      error\n    } = await supabase.rpc('update_username', {\n      p_current_username: currentUsername,\n      p_new_username: newUsername,\n      p_admin_password: adminPassword\n    });\n    if (error) throw error;\n    return data || false;\n  },\n  async updateDisplayName(username, newDisplayName, adminPassword) {\n    const {\n      data,\n      error\n    } = await supabase.rpc('update_display_name', {\n      p_username: username,\n      p_display_name: newDisplayName,\n      p_admin_password: adminPassword\n    });\n    if (error) throw error;\n    return data || false;\n  },\n  async listUsers() {\n    try {\n      console.log('Chamando list_users no Supabase...');\n      const {\n        data,\n        error\n      } = await supabase.rpc('list_users');\n      console.log('Resposta do list_users:', {\n        data,\n        error\n      });\n      if (error) {\n        console.error('Erro ao listar usuários:', error);\n        throw error;\n      }\n      return data || [];\n    } catch (error) {\n      console.error('Erro ao listar usuários:', error);\n      throw error;\n    }\n  },\n  async updateUserCredentials(username, newUsername, newPassword) {\n    try {\n      const {\n        data,\n        error\n      } = await supabase.rpc('update_user_credentials', {\n        p_username: username,\n        p_new_username: newUsername,\n        p_new_password: newPassword\n      });\n      if (error) {\n        console.error('Erro ao atualizar credenciais do usuário:', error);\n        throw error;\n      }\n      return data || false;\n    } catch (error) {\n      console.error('Erro ao atualizar credenciais do usuário:', error);\n      throw error;\n    }\n  }\n};","map":{"version":3,"names":["supabase","authService","signIn","username","password","data","error","rpc","p_username","p_password","Array","isArray","length","user","userData","id","full_name","role","display_name","localStorage","setItem","JSON","stringify","getCurrentUser","storedUser","getItem","currentUser","parse","console","removeItem","updatedUser","signOut","changePassword","adminPassword","newPassword","hasUsername","hasAdminPassword","hasNewPassword","Error","log","p_admin_password","p_new_password","updateUsername","currentUsername","newUsername","p_current_username","p_new_username","updateDisplayName","newDisplayName","p_display_name","listUsers","updateUserCredentials"],"sources":["C:/Users/genil/Desktop/em desemvolvimento Sistema academia/src/lib/auth.ts"],"sourcesContent":["import { supabase } from './supabase';\r\nimport { User, UserListItem } from '../types/auth';\r\n\r\nexport const authService = {\r\n  async signIn(username: string, password: string): Promise<User | null> {\r\n    if (!username || !password) return null;\r\n\r\n    try {\r\n      const { data, error } = await supabase\r\n        .rpc('check_password', {\r\n          p_username: username,\r\n          p_password: password\r\n        });\r\n\r\n      if (error) throw error;\r\n      \r\n      if (data && Array.isArray(data) && data.length > 0) {\r\n        const user = data[0];\r\n        \r\n        const userData: User = {\r\n          id: user.id,\r\n          username: user.username,\r\n          full_name: user.full_name,\r\n          role: user.role,\r\n          display_name: user.display_name\r\n        };\r\n        \r\n        localStorage.setItem('user', JSON.stringify(userData));\r\n        return userData;\r\n      }\r\n\r\n      return null;\r\n    } catch (error) {\r\n      throw error;\r\n    }\r\n  },\r\n\r\n  async getCurrentUser(): Promise<User | null> {\r\n    try {\r\n      const storedUser = localStorage.getItem('user');\r\n      if (!storedUser) return null;\r\n\r\n      const currentUser = JSON.parse(storedUser) as User;\r\n      \r\n      const { data, error } = await supabase\r\n        .rpc('get_user_data', {\r\n          p_username: currentUser.username\r\n        });\r\n\r\n      if (error || !data) {\r\n        console.error('Erro ao buscar usuário:', error);\r\n        localStorage.removeItem('user');\r\n        return null;\r\n      }\r\n\r\n      // Garante que retornamos um objeto único, não um array\r\n      const updatedUser: User = Array.isArray(data) ? data[0] : data;\r\n      \r\n      // Atualiza o localStorage com os dados mais recentes\r\n      localStorage.setItem('user', JSON.stringify(updatedUser));\r\n      return updatedUser;\r\n\r\n    } catch (error) {\r\n      console.error('Erro ao obter usuário atual:', error);\r\n      localStorage.removeItem('user');\r\n      return null;\r\n    }\r\n  },\r\n\r\n  async signOut() {\r\n    localStorage.removeItem('user');\r\n  },\r\n\r\n  async changePassword(username: string, adminPassword: string, newPassword: string): Promise<boolean> {\r\n    try {\r\n      if (!username || !adminPassword || !newPassword) {\r\n        console.error('Dados inválidos:', { \r\n          hasUsername: !!username, \r\n          hasAdminPassword: !!adminPassword, \r\n          hasNewPassword: !!newPassword \r\n        });\r\n        throw new Error('Todos os campos são obrigatórios');\r\n      }\r\n\r\n      // Pega o usuário atual do localStorage\r\n      const currentUser = localStorage.getItem('user');\r\n      if (!currentUser) {\r\n        throw new Error('Usuário não autenticado');\r\n      }\r\n\r\n      const user = JSON.parse(currentUser);\r\n      console.log('Usuário atual:', { username: user.username, role: user.role });\r\n\r\n      console.log('Tentando alterar senha para usuário:', username);\r\n      \r\n      console.log('Chamando change_password com:', {\r\n        username,\r\n        adminPassword,\r\n        newPassword\r\n      });\r\n\r\n      const { data, error } = await supabase\r\n        .rpc('change_password', {\r\n          p_username: username,\r\n          p_admin_password: adminPassword,\r\n          p_new_password: newPassword\r\n        });\r\n\r\n      console.log('Resposta do change_password:', { data, error });\r\n\r\n      if (error) {\r\n        console.error('Erro ao alterar senha:', error);\r\n        throw error;\r\n      }\r\n\r\n      return data || false;\r\n    } catch (error) {\r\n      console.error('Erro ao alterar senha:', error);\r\n      throw error;\r\n    }\r\n  },\r\n\r\n  async updateUsername(currentUsername: string, newUsername: string, adminPassword: string): Promise<boolean> {\r\n    const { data, error } = await supabase\r\n      .rpc('update_username', {\r\n        p_current_username: currentUsername,\r\n        p_new_username: newUsername,\r\n        p_admin_password: adminPassword\r\n      });\r\n\r\n    if (error) throw error;\r\n    return data || false;\r\n  },\r\n\r\n  async updateDisplayName(username: string, newDisplayName: string, adminPassword: string): Promise<boolean> {\r\n    const { data, error } = await supabase\r\n      .rpc('update_display_name', {\r\n        p_username: username,\r\n        p_display_name: newDisplayName,\r\n        p_admin_password: adminPassword\r\n      });\r\n\r\n    if (error) throw error;\r\n    return data || false;\r\n  },\r\n\r\n  async listUsers(): Promise<UserListItem[]> {\r\n    try {\r\n      console.log('Chamando list_users no Supabase...');\r\n      const { data, error } = await supabase\r\n        .rpc('list_users');\r\n\r\n      console.log('Resposta do list_users:', { data, error });\r\n\r\n      if (error) {\r\n        console.error('Erro ao listar usuários:', error);\r\n        throw error;\r\n      }\r\n\r\n      return data || [];\r\n    } catch (error) {\r\n      console.error('Erro ao listar usuários:', error);\r\n      throw error;\r\n    }\r\n  },\r\n\r\n  async updateUserCredentials(username: string, newUsername: string | null, newPassword: string | null): Promise<boolean> {\r\n    try {\r\n      const { data, error } = await supabase\r\n        .rpc('update_user_credentials', {\r\n          p_username: username,\r\n          p_new_username: newUsername,\r\n          p_new_password: newPassword\r\n        });\r\n\r\n      if (error) {\r\n        console.error('Erro ao atualizar credenciais do usuário:', error);\r\n        throw error;\r\n      }\r\n\r\n      return data || false;\r\n    } catch (error) {\r\n      console.error('Erro ao atualizar credenciais do usuário:', error);\r\n      throw error;\r\n    }\r\n  }\r\n}; "],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}